!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var n=t();for(var o in n)("object"==typeof exports?exports:e)[o]=n[o]}}(this,(()=>(()=>{"use strict";var e={86:function(e,t,n){var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,s){function r(e){try{c(o.next(e))}catch(e){s(e)}}function a(e){try{c(o.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,a)}c((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.CaptivateChatAPI=void 0;const i=n(52);let s;if("undefined"!=typeof window&&window.WebSocket)s=window.WebSocket;else if(void 0!==n.g&&n.g.WebSocket)s=n.g.WebSocket;else try{s=n(591)}catch(e){throw new Error("WebSocket not available in this environment and ws module could not be loaded")}function r(e){return new Proxy(e,{get(e,t,n){const i=e[t];return"function"!=typeof i||["isSocketActive","connect","reconnect","getSocket"].includes(t)?i:function(...n){return o(this,void 0,void 0,(function*(){if("function"==typeof e.isSocketActive&&!e.isSocketActive()){console.log("Socket not active, attempting to reconnect...");try{if("function"!=typeof e.reconnect)throw new Error("Reconnect method not available");yield e.reconnect()}catch(e){throw new Error(`Socket reconnection failed. Cannot execute ${String(t)}: ${e.message}`)}}return i.apply(e,n)}))}}})}class a{constructor(e,t="prod"){this.reconnectAttempts=0,this.maxReconnectAttempts=5,this.reconnectDelay=3e3,this.apiKey=e,this.mode=t,this.url="prod"===this.mode?`wss://channel.wss.captivatechat.ai/dev?apiKey=${e}`:`wss://channel-dev.wss.captivatechat.ai/dev?apiKey=${e}`,this.socket=null,this.conversations=new Map}_send(e){this.socket&&this.socket.readyState===s.OPEN?this.socket.send(JSON.stringify(e)):console.error("Socket is not open. Message not sent:",e)}connect(){return o(this,void 0,void 0,(function*(){return new Promise(((e,t)=>{try{this.socket=new s(this.url);const n=setTimeout((()=>{t(new Error("Connection timeout: socket_connected not received"))}),1e4);this.socket.onopen=()=>{console.log("WebSocket connected, waiting for API confirmation...")},this.socket.onmessage=t=>{var o;try{"socket_connected"===(null===(o=JSON.parse(t.data.toString()).event)||void 0===o?void 0:o.event_type)&&(console.log("API Successfully Connected"),clearTimeout(n),e())}catch(e){console.error("Error parsing message:",e)}},this.socket.onerror=e=>{console.error("WebSocket Error:",e.message||e),clearTimeout(n),t(new Error(e.message||"WebSocket error"))},this.socket.onclose=e=>{console.log("WebSocket connection closed with",e.code),1e3!==e.code&&(console.log("Attempting to reconnect..."),setTimeout((()=>this.connect()),3e3))}}catch(e){t(e)}}))}))}createConversation(e){return o(this,arguments,void 0,(function*(e,t={},n={},o="bot-first",s={}){return new Promise(((a,c)=>{var d;try{const l=Object.assign({},n);s&&(l.private=s),this._send({action:"sendMessage",event:{event_type:"conversation_start",event_payload:{userId:e,userBasicInfo:t,metadata:l}}});const v=e=>{var t,n;try{const s=JSON.parse(e.data.toString());if("conversation_start_success"===(null===(t=s.event)||void 0===t?void 0:t.event_type)){const e=s.event.event_payload.conversation_id;null===(n=this.socket)||void 0===n||n.removeEventListener("message",v);const t=r(new i.Conversation(e,this.socket,{},this.apiKey,this.mode));this.conversations.set(e,t),"bot-first"===o?t.sendMessage({type:"text",text:""}).then((()=>a(t))).catch(c):a(t)}}catch(e){console.error("Error processing message:",e)}};null===(d=this.socket)||void 0===d||d.addEventListener("message",v),setTimeout((()=>{var e;null===(e=this.socket)||void 0===e||e.removeEventListener("message",v),c(new Error("Timeout: No response for createConversation"))}),1e4)}catch(e){c(e)}}))}))}getConversation(e){let t=this.conversations.get(e);if(!t){if(null===this.socket)throw console.error("Socket is not initialized"),new Error("WebSocket connection not established");t=r(new i.Conversation(e,this.socket,{},this.apiKey,this.mode)),this.conversations.set(e,t)}return null==t||t.restartListeners(),t}getUserConversations(e){return o(this,void 0,void 0,(function*(){const t="string"==typeof e?{userId:e}:e,{userId:n,filter:o={},search:s={},pagination:a={},apiKeys:c}=t,d=[];let l;const v=o&&Object.keys(o).length>0||s&&Object.keys(s).length>0||a&&Object.keys(a).length>0||c&&Array.isArray(c)&&c.length>0;return new Promise(((e,t)=>{var h;try{if(v){const e={userId:n};o&&Object.keys(o).length>0&&(e.filter=o),s&&Object.keys(s).length>0&&(e.search=s),a&&Object.keys(a).length>0&&(e.pagination=a),c&&Array.isArray(c)&&c.length>0&&(e.apiKeys=c),this._send({action:"sendMessage",event:{event_type:"get_user_conversations_v2",event_payload:e}})}else this._send({action:"sendMessage",event:{event_type:"get_user_conversations",event_payload:{userId:n}}});const u=n=>{var o,s;try{const t=JSON.parse(n.data.toString());if("user_conversations"===(null===(o=t.event)||void 0===o?void 0:o.event_type)){null===(s=this.socket)||void 0===s||s.removeEventListener("message",u);const n=t.event.event_payload.conversations;for(const e of n){const{conversation_id:t,metadata:n,apiKey:o}=e;null!==this.socket&&d.push(r(new i.Conversation(t,this.socket,n,o||this.apiKey,this.mode)))}t.event.event_payload.pagination&&(l=t.event.event_payload.pagination),e({conversations:d,pagination:l})}}catch(e){console.error("Error processing message:",e),t(e)}};null===(h=this.socket)||void 0===h||h.addEventListener("message",u),setTimeout((()=>{var e;null===(e=this.socket)||void 0===e||e.removeEventListener("message",u),t(new Error("Timeout: No response for getUserConversations"))}),1e4)}catch(e){t(e)}}))}))}deleteUserConversations(e){return o(this,void 0,void 0,(function*(){return new Promise(((t,n)=>{var o;if(!e)return n(new Error("User ID must be provided."));try{this._send({action:"sendMessage",event:{event_type:"delete_conversation",event_payload:{userId:e}}});const i=o=>{var s,r;try{const n=JSON.parse(o.data.toString());"delete_conversation_success"===(null===(s=n.event)||void 0===s?void 0:s.event_type)&&n.event.event_payload.userId===e&&(null===(r=this.socket)||void 0===r||r.removeEventListener("message",i),t())}catch(e){n(e)}};null===(o=this.socket)||void 0===o||o.addEventListener("message",i),setTimeout((()=>{var t;null===(t=this.socket)||void 0===t||t.removeEventListener("message",i),n(new Error(`Timeout: No response for deleting conversations for user ${e}`))}),1e4)}catch(e){n(e)}}))}))}getSocket(){return this.socket}isSocketActive(){return!!this.socket&&this.socket.readyState===s.OPEN}reconnect(){return o(this,void 0,void 0,(function*(){if(this.reconnectAttempts>=this.maxReconnectAttempts)throw new Error(`Max reconnection attempts (${this.maxReconnectAttempts}) reached`);this.reconnectAttempts++,console.log(`Attempting to reconnect... (${this.reconnectAttempts}/${this.maxReconnectAttempts})`);try{yield this.connect(),this.reconnectAttempts=0,console.log("Reconnection successful")}catch(e){if(console.error(`Reconnection attempt ${this.reconnectAttempts} failed:`,e),this.reconnectAttempts<this.maxReconnectAttempts)return yield new Promise((e=>setTimeout(e,this.reconnectDelay))),this.reconnect();throw e}}))}static create(e){return o(this,arguments,void 0,(function*(e,t="prod"){const n=new a(e,t);return yield n.connect(),r(n)}))}}t.CaptivateChatAPI=a},392:function(e,t){var n=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,s){function r(e){try{c(o.next(e))}catch(e){s(e)}}function a(e){try{c(o.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,a)}c((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.CaptivateChatFileInput=void 0;class o{constructor(e,t,n){this.type="files";const o=t.metadata.originalFileName,i=t.metadata.storageType||"direct";if("external"===i&&"string"==typeof e)this.files=[{filename:o,type:n,url:e,textContent:t}];else{if("direct"!==i||!(e instanceof File||e instanceof Blob))throw new Error("Invalid file or URL type for the specified storage type");this.files=[{filename:o,type:n,file:e,textContent:t}]}}static create(e,t){return n(this,void 0,void 0,(function*(){if(e instanceof File||e instanceof Blob){const n=e,i=(null==t?void 0:t.fileName)||(n instanceof File?n.name:`attachment_${Date.now()}`),s=(null==t?void 0:t.fileType)||(n instanceof File?n.type:n.type||"application/octet-stream"),r=yield o.convertFileToText(n,i,(null==t?void 0:t.includeMetadata)||!1),a=new o(n,{type:"file_content",text:r,metadata:{source:"file_attachment",originalFileName:i,storageType:"direct"}},s);return o.createProxy(a)}{const t=e;if(!t.fileName||!t.fileType||!t.url)throw new Error("fileName, fileType, and url are required when using external URL");const n=yield o.convertUrlToText(t.url,t.fileName,t.includeMetadata||!1),i=new o(t.url,{type:"file_content",text:n,metadata:{source:"file_attachment",originalFileName:t.fileName,storageType:"external"}},t.fileType);return o.createProxy(i)}}))}getFirstFile(){return this.files[0]}getFilename(){var e;return null===(e=this.files[0])||void 0===e?void 0:e.filename}getTextContent(){var e,t;return(null===(t=null===(e=this.files[0])||void 0===e?void 0:e.textContent)||void 0===t?void 0:t.text)||""}getFileType(){var e;return null===(e=this.files[0])||void 0===e?void 0:e.type}toFilesArray(){return this.files}*[Symbol.iterator](){yield*this.files}get[Symbol.toStringTag](){return"Array"}get length(){return this.files.length}static createProxy(e){return new Proxy(e,{get:(e,t)=>t===Symbol.iterator||"length"===t||"number"==typeof t?e.files[t]:e[t]})}static createFile(e,t){return n(this,void 0,void 0,(function*(){return(yield o.create(e,t)).getFirstFile()}))}static createMultiple(e,t){return n(this,void 0,void 0,(function*(){if(e.length>0&&(e[0]instanceof File||e[0]instanceof Blob)){const n=e,i=(yield Promise.all(n.map((e=>o.create(e,{includeMetadata:(null==t?void 0:t.includeMetadata)||!1}))))).flatMap((e=>e.files)),s=new o(n[0],{type:"file_content",text:"",metadata:{source:"file_attachment",originalFileName:"multiple_files",storageType:"direct"}},"application/octet-stream");return s.files=i,o.createProxy(s)}{const t=e,n=yield Promise.all(t.map((e=>o.create(e)))),i=n.flatMap((e=>e.files)),s=new o(t[0].url,{type:"file_content",text:"",metadata:{source:"file_attachment",originalFileName:"multiple_files",storageType:"external"}},t[0].fileType);return s.files=i,o.createProxy(s)}}))}static convertFileToText(e,t,i){return n(this,void 0,void 0,(function*(){const n=o.FILE_TO_TEXT_API_URL,s=new FormData;s.append("file",e,t),s.append("includeMetadata",i.toString());try{const e=yield fetch(n,{method:"POST",body:s});if(!e.ok){const t=yield e.json().catch((()=>({})));throw new Error(`File conversion failed: ${e.status} ${e.statusText}. ${t.error||""}`)}const t=yield e.json();if(!t.success)throw new Error(`File conversion failed: ${t.error||"Unknown error"}`);return t.text||""}catch(e){if(e.message.includes("File conversion failed"))throw e;throw new Error(`Failed to convert file to text: ${e.message}`)}}))}static convertUrlToText(e,t,i){return n(this,void 0,void 0,(function*(){const n=o.FILE_TO_TEXT_API_URL,s=new FormData;s.append("url",e),s.append("fileName",t),s.append("includeMetadata",i.toString());try{const e=yield fetch(n,{method:"POST",body:s});if(!e.ok){const t=yield e.json().catch((()=>({})));throw new Error(`File conversion failed: ${e.status} ${e.statusText}. ${t.error||""}`)}const t=yield e.json();if(!t.success)throw new Error(`File conversion failed: ${t.error||"Unknown error"}`);return t.text||""}catch(e){if(e.message.includes("File conversion failed"))throw e;throw new Error(`Failed to convert URL to text: ${e.message}`)}}))}}t.CaptivateChatFileInput=o,o.FILE_TO_TEXT_API_URL="https://file-to-text.prod.captivat.io/api/file-to-text"},629:function(e,t,n){var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,s){function r(e){try{c(o.next(e))}catch(e){s(e)}}function a(e){try{c(o.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,a)}c((o=o.apply(e,t||[])).next())}))},i=this&&this.__rest||function(e,t){var n={};for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&t.indexOf(o)<0&&(n[o]=e[o]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(o=Object.getOwnPropertySymbols(e);i<o.length;i++)t.indexOf(o[i])<0&&Object.prototype.propertyIsEnumerable.call(e,o[i])&&(n[o[i]]=e[o[i]])}return n};Object.defineProperty(t,"__esModule",{value:!0}),t.CaptivateChatManager=void 0;const s=n(86),r=n(52);class a{constructor(e,t="prod"){this.apiInstances={};for(const n of e)this.apiInstances[n]=new s.CaptivateChatAPI(n,t)}static create(e){return o(this,arguments,void 0,(function*(e,t="prod"){const n=Object.create(a.prototype);n.apiInstances={};for(const o of e)n.apiInstances[o]=yield s.CaptivateChatAPI.create(o,t);return n}))}connectAll(){return o(this,void 0,void 0,(function*(){yield Promise.all(Object.values(this.apiInstances).map((e=>e.connect())))}))}getUserConversations(e){return o(this,void 0,void 0,(function*(){const t=e.apiKeys||Object.keys(this.apiInstances),n=this.apiInstances[t[0]],{apiKeys:o}=e,s=i(e,["apiKeys"]),a=yield n.getUserConversations(Object.assign(Object.assign({},s),{apiKeys:t}));return{conversations:a.conversations.map((e=>{const t=e.apiKey,n=this.apiInstances[t];if(!n)throw new Error(`No CaptivateChatAPI instance for apiKey: ${t}`);if(!n.getSocket())throw new Error(`WebSocket not initialized for apiKey: ${t}`);return new r.Conversation(e.conversationId,n.getSocket(),e.metadata,t)})),pagination:a.pagination}}))}getApiInstance(e){return this.apiInstances[e]}}t.CaptivateChatManager=a},52:function(e,t){var n=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,s){function r(e){try{c(o.next(e))}catch(e){s(e)}}function a(e){try{c(o.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,a)}c((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.Conversation=void 0,t.Conversation=class{constructor(e,t,n,o,i){this.apiKey=o||"",this.conversationId=e,this.socket=t,this.listeners=new Map,this.metadata=n||null,this.local_id=Math.floor(1e4*Math.random()),this.mode=i||"prod",this.socket.onmessage=this.handleMessage.bind(this)}handleMessage(e){var t,n;const o=JSON.parse(e.data),i=null===(t=o.event)||void 0===t?void 0:t.event_type;if(i&&this.listeners.has(i)){const e=o.event.event_payload;null===(n=this.listeners.get(i))||void 0===n||n.forEach((t=>t(e)))}}restartListeners(){this.socket.onmessage=this.handleMessage.bind(this)}addListener(e,t){var n;this.restartListeners(),this.listeners.has(e)||this.listeners.set(e,[]),null===(n=this.listeners.get(e))||void 0===n||n.push(t)}onMessage(e){this.addListener("bot_message",(t=>e(t.content,"ai_agent"))),this.addListener("livechat_message",(t=>e(t.content,"human_agent"))),this.addListener("general_error",(t=>n(this,void 0,void 0,(function*(){if(413===t.error_code&&t.message_link)try{const n=yield fetch(t.message_link,{method:"GET",headers:{"x-api-key":this.apiKey,Accept:"application/json"}});if(!n.ok)throw new Error(`Failed to fetch large message: ${n.status} ${n.statusText}`);const o=yield n.json();e(o.botMessage.content,"ai_agent")}catch(t){console.error("Error fetching large message:",t),e(`[Error fetching large message: ${t.message}]`,"error")}else console.log("Not a large message error or no message_link provided"),e(`[Error: ${t.error_desc||"Unknown error"}]`,"error")}))))}onActionReceived(e){this.addListener("action",(t=>e(t.actions)))}onConversationUpdate(e){this.addListener("conversation_update",(t=>{e({type:t.type,conversationId:t.conversation_id,data:t.data})}))}onError(e){this.addListener("general_error",(t=>{e({conversationId:t.conversation_id,errorCode:t.error_code,errorDesc:t.error_desc})}))}sendMessage(e){return n(this,void 0,void 0,(function*(){return"string"==typeof e&&(e={type:"text",text:e}),this.sendPayload("user_message",{type:"message_create",client_msg_id:`unique-message-id-${Date.now()}`,conversation_id:this.conversationId,content:e})}))}setMetadata(e){return n(this,void 0,void 0,(function*(){if("object"!=typeof e||null===e)throw new Error("Metadata must be a non-null object.");return new Promise(((t,n)=>{const o={action:"sendMessage",event:{event_type:"metadata",event_payload:{metadata:e,client_msg_id:`metadata-${Date.now()}`,conversation_id:this.conversationId}}};this.socket.send(JSON.stringify(o));const i=e=>{e.conversation_id===this.conversationId&&(this.removeListener("metadata_update_success",i),t(e))};this.addListener("metadata_update_success",i),setTimeout((()=>{this.removeListener("metadata_update_success",i),n(new Error("Timeout: No response for metadata update"))}),15e3)}))}))}setPrivateMetadata(e){return n(this,void 0,void 0,(function*(){if("object"!=typeof e||null===e)throw new Error("Private metadata must be a non-null object.");return this.setMetadata({private:e})}))}sendAction(e){return n(this,arguments,void 0,(function*(e,t={}){return this.sendPayload("action",{type:"normal",id:e,data:t,conversation_id:this.conversationId})}))}getTranscript(){return n(this,void 0,void 0,(function*(){if(!this.apiKey)throw new Error("API key is required to fetch transcript via REST.");const e=`${"prod"===this.mode?"https://channel.prod.captivat.io":"https://channel.dev.captivat.io"}/api/transcript?conversation_id=${encodeURIComponent(this.conversationId)}`,t=yield fetch(e,{method:"GET",headers:{"x-api-key":this.apiKey,Accept:"application/json"}});if(!t.ok)throw new Error(`Failed to fetch transcript: ${t.status} ${t.statusText}`);return(yield t.json()).transcript}))}getMetadata(){return n(this,void 0,void 0,(function*(){return new Promise(((e,t)=>{const n={action:"sendMessage",event:{event_type:"metadata_request",event_payload:{conversation_id:this.conversationId}}};this.socket.send(JSON.stringify(n));const o=t=>{t.conversation_id===this.conversationId&&(this.removeListener("conversation_metadata",o),e(t.content))};this.addListener("conversation_metadata",o),setTimeout((()=>{this.removeListener("conversation_metadata",o),t(new Error("Timeout: No response for metadata request"))}),1e4)}))}))}delete(){return n(this,void 0,void 0,(function*(){return new Promise(((e,t)=>{try{const n={action:"sendMessage",event:{event_type:"delete_conversation",event_payload:{conversation_id:this.conversationId}}};this.socket.send(JSON.stringify(n));const o=t=>{var n;const i=JSON.parse(t.data);"delete_conversation_success"===(null===(n=i.event)||void 0===n?void 0:n.event_type)&&i.event.event_payload.conversation_id===this.conversationId&&(this.socket.removeEventListener("message",o),e())};this.socket.addEventListener("message",o),setTimeout((()=>{this.socket.removeEventListener("message",o),t(new Error(`Timeout: No response for deleting conversation ${this.conversationId}`))}),1e4)}catch(e){t(e)}}))}))}fileToBase64(e){return new Promise(((t,n)=>{const o=new FileReader;o.onload=()=>{const e=o.result.split(",")[1];t(e)},o.onerror=n,o.readAsDataURL(e)}))}blobToBase64(e){return new Promise(((t,n)=>{const o=new FileReader;o.onload=()=>{const e=o.result.split(",")[1];t(e)},o.onerror=n,o.readAsDataURL(e)}))}editMessage(e,t){return n(this,void 0,void 0,(function*(){return"string"==typeof t&&(t={type:"text",text:t}),new Promise(((n,o)=>{this.sendPayload("edit_message",{type:"message_create",client_msg_id:`edit-message-id-${Date.now()}`,conversation_id:this.conversationId,message_id:e,content:t});const i=t=>{t.conversation_id===this.conversationId&&t.message_id===e&&(this.removeListener("message_edited_success",i),n())};this.addListener("message_edited_success",i),setTimeout((()=>{this.removeListener("message_edited_success",i),o(new Error("Timeout: No response for message edit"))}),1e4)}))}))}sendPayload(e,t){return n(this,void 0,void 0,(function*(){return new Promise(((n,o)=>{try{const o={action:"sendMessage",event:{event_type:e,event_payload:t}};this.socket.send(JSON.stringify(o)),n()}catch(e){o(e)}}))}))}removeListener(e,t){const n=this.listeners.get(e);n&&this.listeners.set(e,n.filter((e=>e!==t)))}getConversationId(){return this.conversationId}}},591:e=>{e.exports=function(){throw new Error("ws does not work in the browser. Browser clients must use the native WebSocket object")}}},t={};function n(o){var i=t[o];if(void 0!==i)return i.exports;var s=t[o]={exports:{}};return e[o].call(s.exports,s,s.exports,n),s.exports}n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}();var o={};return(()=>{var e=o;Object.defineProperty(e,"__esModule",{value:!0}),e.CaptivateChatFileInput=e.CaptivateChatManager=e.CaptivateChatAPI=void 0;const t=n(86);Object.defineProperty(e,"CaptivateChatAPI",{enumerable:!0,get:function(){return t.CaptivateChatAPI}});const i=n(629);Object.defineProperty(e,"CaptivateChatManager",{enumerable:!0,get:function(){return i.CaptivateChatManager}});const s=n(392);Object.defineProperty(e,"CaptivateChatFileInput",{enumerable:!0,get:function(){return s.CaptivateChatFileInput}}),"undefined"!=typeof window&&(window.CaptivateChatAPI=t.CaptivateChatAPI,window.CaptivateChatManager=i.CaptivateChatManager,window.CaptivateChatFileInput=s.CaptivateChatFileInput)})(),o})()));